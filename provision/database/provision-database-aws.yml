#
# Setup Content Store on AWS RDS hosted on a MySQL instance
#

- include_vars: ../../vars/aws/region.yml
- include_vars: ../../vars/aws/rds.yml
- include_vars: ../../vars/aws/tags.yml
- include_vars: ../../vars/aws/vpc.yml

- include_vars: ../../vars/contentstore.yml

# Provision an RDS subnet group to host the RDS instance
- include: aws/tasks/rds-subnet.yml
  vars:
    rds_subnet_groupname: "{{ contentstore_subnet_groupname }}"
    subnets:
      - "{{ subnet_contentstore_1_id }}"
      - "{{ subnet_contentstore_2_id }}"

# Provision Content Store as an RDS instance
- include: aws/tasks/rds.yml
  vars:
    rds_instance_name: "{{ contentstore_database_instance_name }}"
    database_size: "{{ contentstore_database_size }}"
    rds_multi_az: yes
    rds_instance_type: "{{ contentstore_database_instance_type }}"
    rds_db_name: "{{ contentstore_database_name }}"
    rds_username: "{{ contentstore_database_username }}"
    rds_password: "{{ contentstore_database_password }}"
    vpc_security_groups: "{{ inbound_sg.results[2].group_id }}"
    subnets: "{{ contentstore_subnet_groupname }}"

- name: Website | Provision database | AWS | RDS | Store RDS instance information
  set_fact: contentstore_database_host="{{ rds.instance.endpoint }}"